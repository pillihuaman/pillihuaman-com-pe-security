name: Deploy to AWS EC2

on:
  push:
    branches:
      - master

env:
  AWS_REGION: us-east-2
  EC2_INSTANCE_1_IP: 18.191.52.191
  EC2_INSTANCE_2_IP: 3.145.180.222
  EC2_USER: ec2-user
  AWS_DEFAULT_REGION: us-east-2

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up AWS CLI
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Save EC2 key pair to file
        run: |
          echo "${{ secrets.EC2_KEY_PAIR_PATH }}" > ec2_key.pem
          chmod 400 ec2_key.pem

      - name: Install Java and Maven
        run: |
          sudo apt-get update
          sudo apt-get install -y openjdk-17-jdk maven

      - name: Authenticate with AWS CodeArtifact and configure Maven
        run: |
          AUTH_TOKEN=$(aws codeartifact get-authorization-token --domain pillihuamanlib --domain-owner 570123367471 --query authorizationToken --output text)

          mkdir -p ~/.m2

          cat > ~/.m2/settings.xml <<EOF
<settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 https://maven.apache.org/xsd/settings-1.0.0.xsd">

  <servers>
    <server>
      <id>pillihuamanlib-pillihuaman-com-pe-lib</id>
      <username>aws</username>
      <password>${AUTH_TOKEN}</password>
    </server>
  </servers>

  <profiles>
    <profile>
      <id>pillihuamanlib-pillihuaman-com-pe-lib</id>
      <activation>
        <activeByDefault>true</activeByDefault>
      </activation>
      <repositories>
        <repository>
          <id>pillihuamanlib-pillihuaman-com-pe-lib</id>
          <url>https://pillihuamanlib-570123367471.d.codeartifact.us-east-2.amazonaws.com/maven/pillihuaman-com-pe-lib/</url>
        </repository>
      </repositories>
    </profile>
  </profiles>

  <mirrors>
    <mirror>
      <id>pillihuamanlib-pillihuaman-com-pe-lib</id>
      <name>pillihuamanlib-pillihuaman-com-pe-lib</name>
      <url>https://pillihuamanlib-570123367471.d.codeartifact.us-east-2.amazonaws.com/maven/pillihuaman-com-pe-lib/</url>
      <mirrorOf>*</mirrorOf>
    </mirror>
  </mirrors>

</settings>
EOF

      - name: Build JAR with Maven
        run: mvn clean install -DskipTests

      - name: Copy JAR files to EC2 instance 1
        run: |
          scp -i ec2_key.pem -o StrictHostKeyChecking=no target/pillihuaman-com-pe-security-0.0.1-SNAPSHOT.jar ${{ env.EC2_USER }}@${{ env.EC2_INSTANCE_1_IP }}:/home/${{ env.EC2_USER }}/
          scp -i ec2_key.pem -o StrictHostKeyChecking=no target/pillihuaman-com-pe-support-0.0.1-SNAPSHOT.jar ${{ env.EC2_USER }}@${{ env.EC2_INSTANCE_1_IP }}:/home/${{ env.EC2_USER }}/

      - name: Copy JAR files to EC2 instance 2
        run: |
          scp -i ec2_key.pem -o StrictHostKeyChecking=no target/pillihuaman-com-pe-security-0.0.1-SNAPSHOT.jar ${{ env.EC2_USER }}@${{ env.EC2_INSTANCE_2_IP }}:/home/${{ env.EC2_USER }}/
          scp -i ec2_key.pem -o StrictHostKeyChecking=no target/pillihuaman-com-pe-support-0.0.1-SNAPSHOT.jar ${{ env.EC2_USER }}@${{ env.EC2_INSTANCE_2_IP }}:/home/${{ env.EC2_USER }}/

      - name: Restart services on EC2 instance 1
        run: |
          ssh -i ec2_key.pem -o StrictHostKeyChecking=no ${{ env.EC2_USER }}@${{ env.EC2_INSTANCE_1_IP }} << 'EOF'
            sudo systemctl stop pillihuaman-com-pe-security || true
            sudo systemctl start pillihuaman-com-pe-security
            sudo systemctl stop pillihuaman-com-pe-support || true
            sudo systemctl start pillihuaman-com-pe-support
          EOF

      - name: Restart services on EC2 instance 2
        run: |
          ssh -i ec2_key.pem -o StrictHostKeyChecking=no ${{ env.EC2_USER }}@${{ env.EC2_INSTANCE_2_IP }} << 'EOF'
            sudo systemctl stop pillihuaman-com-pe-security || true
            sudo systemctl start pillihuaman-com-pe-security
            sudo systemctl stop pillihuaman-com-pe-support || true
            sudo systemctl start pillihuaman-com-pe-support
          EOF
